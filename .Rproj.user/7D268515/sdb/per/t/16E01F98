{
    "collab_server" : "",
    "contents" : "\n\nlibrary(RPostgreSQL)\nlibrary(plyr)\nlibrary(dplyr)\nlibrary(ggplot2)\n\ndriver <- dbDriver(\"PostgreSQL\") \nconn <- dbConnect(driver, host=\"superevilmegacorp.redshift.amplitude.com\",\n                  port=\"5439\",\n                  dbname=\"superevilmegacorp\",\n                  user=\"superevilmegacorp\",\n                  password=\"GQdPSadICW2lL5qCkS20U9Jk\")\n\nuser_elo_decay_b_1_match_sql  <-\n\"Select\naccount_id \n,event_time \n,event_time_rank       \n,first_login_date\n,days_since_active\n,pre_churn_lifetime_days \n,player_elo \n,player_elo_lag  \n,pre_post_1_match_elo_diff as final_elo_diff\nFrom reactivated_accounts_e_v2\nGroup By 1,2,3,4,5,6,7,8,9\"\n\nuser_elo_decay_b <- dbGetQuery(conn, paste(\"SET search_path = app139203;\",\n                                         user_elo_decay_b_1_match_sql, sep = \"\"))\n\nhead(user_elo_decay_b)\nstr(user_elo_decay_b)  #389,162 obs. of  4 variables:\nsort(unique(user_elo_decay_b$final_elo_diff))\nclass(user_elo_decay_b$final_elo_diff)\n\n#how many are NA \n  # 155,443 this is quite large \nsum(is.na(user_elo_decay_b$final_elo_diff))\n\n#remove the NA values \nuser_elo_decay_b <- filter(user_elo_decay_b, !is.na(final_elo_diff))\n\nstr(user_elo_decay_b)  #233,719 obs. of  4 variables:\n\nhist(user_elo_decay_b$final_elo_diff)\n\nmean(user_elo_decay_b$final_elo_diff)\n\npar(mfrow = c(1,2))\n\nhist(user_elo_decay_b$final_elo_diff,\n     breaks = seq(from = min(user_elo_decay_b$final_elo_diff),\n                  to = max(user_elo_decay_b$final_elo_diff),\n                  by = 1),\n     main = \"ELO Differece Pre/Post Reactivation\",\n     xlab = \"ELO Differece\")\n\nuser_elo_decay_b_2 <- filter(user_elo_decay_b,\n                           final_elo_diff >= -100,\n                           final_elo_diff <= 100)\n\nstr(user_elo_decay_b_2) #230,930 obs. of  4 variables\n# keeps 0.9880669 of the records, but removing the NAs one step above removed a large # or rows \n230930 / 233719 \n\n#range checks \nmin(as.numeric(user_elo_decay_b_2$final_elo_diff)); max(user_elo_decay_b_2$final_elo_diff)\n\n# final_elo_diff\nhist(user_elo_decay_b_2$final_elo_diff, \n     breaks = seq(from = -100, to = 100, by = 1),\n     main = \"Outlier Removed \\n ELO Differece Pre/Post Reactivation\",\n     xlab = \"ELO Differece\")   \n\n\n#create dsa_quartiles for days_since_active\nuser_elo_decay_b_2_a <- \n  user_elo_decay_b_2 %>%  \n  mutate(dsa_quartiles = ntile(days_since_active, 4))\n\n#checks\nhead(user_elo_decay_b_2_a)\nstr(user_elo_decay_b_2_a) \n\n#plot elo diff distributions by days since active dsa_quartiles \ngg1 <- ggplot(user_elo_decay_b_2_a,\n             aes(x = final_elo_diff)) + \n  geom_histogram(aes(fill = ..count..),  # creates a gradient legend by relative counts \n                 bins = 55) + \n  ggtitle(\"Histogram of ELO Diff. by Days Since Active Quartile\") + \n  facet_wrap(~ dsa_quartiles, ncol = 2)\n\n#filter days since active <= 27 (for better charting)\n#facet wrap dist. at each level of days since active \ngg1b <- ggplot(subset(user_elo_decay_b_2_a, days_since_active <= 27),\n              aes(x = final_elo_diff)) + \n  geom_histogram(aes(fill = ..count..),  # creates a gradient legend by relative counts \n                 bins = 55) + \n  ggtitle(\"Histogram of ELO Diff. by Days Since Active Quartile\") + \n  ggtitle(expression(atop(\"ELO Diff. by Days Since Active                \", \n                          atop(italic(\"Note Showing Days Since Actve from 8 to 27\"), \"\")))) +\n  facet_wrap(~ days_since_active, \n             # scales = \"free\",\n             ncol = 5)\n\n#filter days since active <= 25 (for better charting)\n#facet wrap dist. at each level of days since active \ngg1c <- ggplot(subset(user_elo_decay_b_2_a, pre_churn_lifetime_days <= 24),\n              aes(x = final_elo_diff)) + \n  geom_histogram(aes(fill = ..count..),  # creates a gradient legend by relative counts \n                 bins = 55) + \n  ggtitle(expression(atop(\"Histogram of Avg. ELO Diff. by Pre Churn Lifetime Days\", \n                          atop(italic(\"Note Showing Pre Churn Lifetime Days from 0 to 24\"), \"\")))) +\n  facet_wrap(~ pre_churn_lifetime_days, \n             # scales = \"free\",\n             ncol = 5)\n\n# GET AVG ELO Diff. by days since active \n  #naming it 2 so that there is no conflict between scripts\navg_elo_decay_by_days_since_active_2 <-\n  user_elo_decay_b_2_a %>%  \n  select(days_since_active, final_elo_diff) %>% \n  group_by(days_since_active) %>% \n  summarise(avg_final_elo_diff = mean(final_elo_diff, na.rm = TRUE))\n\nhead(avg_elo_decay_by_days_since_active_2)\n\n#plot AVG ELO Diff. by days since active \ngg9 <- ggplot(avg_elo_decay_by_days_since_active_2,\n             aes(x = days_since_active,\n                 y = avg_final_elo_diff)) + \n  geom_bar(stat = \"identity\") +\n  ggtitle(\"Avg. ELO Diff. by Days Since Active\") +\n  labs(x = \"Days Since Active\", y = \"Avg. Final ELO Diff.\") +\n  theme(legend.position=\"bottom\") +\n  theme(axis.text.x = element_text(size = 10, angle = 00))\n\n\n# GET AVG ELO Diff. by pre_churn_lifetime_days\n  #naming it 2 so that there is no conflict between scripts\navg_elo_decay_by_pre_churn_lifetime_days_2 <-\n  user_elo_decay_b_2_a %>%  \n  select(pre_churn_lifetime_days, final_elo_diff) %>% \n  group_by(pre_churn_lifetime_days) %>% \n  summarise(avg_final_elo_diff = mean(final_elo_diff, na.rm = TRUE))\n\n#plot AVG ELO Diff. by pre_churn_lifetime_days\ngg10 <- ggplot(avg_elo_decay_by_pre_churn_lifetime_days_2,\n              aes(x = pre_churn_lifetime_days,\n                  y = avg_final_elo_diff\n              )) + \n  geom_bar(stat = \"identity\") +\n  ggtitle(\"Avg. ELO Diff. by Pre Churn Lifetime Days\") +\n  labs(x = \"Pre Churn Lifetime Days\", y = \"Avg. Final ELO Diff.\") +\n  theme(legend.position=\"bottom\") +\n  theme(axis.text.x = element_text(size = 10, angle = 00))  \n\n\n#create player_elo buckets \nuser_elo_decay_b_2_a <-\n  user_elo_decay_b_2_a %>%\n  transform(player_elo_buckets = floor(player_elo / 100))\n\n#check player_elo_buckets ranges \nuser_elo_decay_b_2_a_buckets_check <- \n  user_elo_decay_b_2_a %>%\n  filter(player_elo, player_elo_buckets) %>% \n  group_by(player_elo_buckets) %>% \n  summarise(min_player_elo = min(player_elo),\n            max_player_elo = max(player_elo))\n\n#annoying way to print entire tibble \nprint(tbl_df(user_elo_decay_b_2_a_buckets_check), n=40)\n\n#plot elo diff distributions by player_elo_buckets\ngg11 <- ggplot(user_elo_decay_b_2_a,\n             aes(x = final_elo_diff)) + \n  geom_histogram(aes(fill = ..count..),  # creates a gradient legend by relative counts \n                 bins = 55) + \n  ggtitle(\"Histogram of ELO Diff. by ELO Bucket\") + \n  facet_wrap(~ player_elo_buckets, ncol = 5)\n\n\nhead(user_elo_decay_b_2_a)\n\n# GET AVG ELO Diff. by player_elo_buckets\n  # adding 2 at end to avoid conflicting names between scripts\navg_elo_decay_by_player_elo_buckets_2 <-\n  user_elo_decay_b_2_a %>%  \n  select(player_elo_buckets, final_elo_diff) %>% \n  group_by(player_elo_buckets) %>% \n  summarise(avg_final_elo_diff = mean(final_elo_diff, na.rm = TRUE))\n\n#check data \nprint(tbl_df(avg_elo_decay_by_player_elo_buckets_2), n=30)\n\n#plot AVG ELO Diff. by player_elo_buckets\ngg12 <- ggplot(avg_elo_decay_by_player_elo_buckets_2,\n              aes(x = player_elo_buckets,\n                  y = avg_final_elo_diff)) + \n  geom_bar(stat = \"identity\") +\n  ggtitle(\"Avg. ELO Diff. by ELO Bucket\") +\n  labs(x = \"ELO Bucket\", y = \"Avg. ELO Diff.\") +\n  theme(legend.position=\"bottom\") +\n  theme(axis.text.x = element_text(size = 10, angle = 00))  \n\n\n\n\n\n",
    "created" : 1478040045430.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1333769816",
    "id" : "16E01F98",
    "lastKnownWriteTime" : 1478119873,
    "last_content_update" : 1478119873266,
    "path" : "~/Desktop/Redshift_Cron/R_Work/R_Projects/MMR Decay/elo_decay_1_day.R",
    "project_path" : "elo_decay_1_day.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}