{
    "collab_server" : "",
    "contents" : "## Dominic Mullen\n## 10/12/2016 \n\nlibrary (RPostgreSQL)\nlibrary(data.table)\nlibrary(plyr)\nlibrary(ggplot2)\nlibrary(plotly)\n\ndriver <- dbDriver(\"PostgreSQL\") \nconn <- dbConnect(driver, host=\"superevilmegacorp.redshift.amplitude.com\",\n                  port=\"5439\",\n                  dbname=\"superevilmegacorp\",\n                  user=\"superevilmegacorp\",\n                  password=\"GQdPSadICW2lL5qCkS20U9Jk\")\n\n# # Import Data \n# mmrData_sql  <- \"Select \n# days_since_active\n# ,pre_churn_lifetime_days\n# ,avg(avg_pre_churn_mmr_diff) overall_avg_pre_churn_mmr_diff\n# ,avg(avg_post_churn_mmr_diff) overall_avg_post_churn_mmr_diff        \n# ,avg(final_mmr_diff) final_mmr_diff \n# From reactivated_users_4\n# Group By 1,2\" \n# \n# mmrData <- dbGetQuery(conn, paste(\"SET search_path = app139203;\",mmrData_sql, sep = \"\"))\n# \n# # data table \n# mmrData <- data.table(mmrData)\n# \n# # Data exploration \n# head(mmrData)\n# \n# summary(mmrData)\n# dim(mmrData) # n = 8601 \n# mmrData[final_mmr_diff != 0]\n# # only 41 / 8607 show a change \n# \n# # Distributions \n# hist(mmrData$days_since_active)\n# plot(density(mmrData$days_since_active))\n# \n# hist(mmrData$pre_churn_lifetime_days)\n# plot(density(mmrData$pre_churn_lifetime_days), col = \"blue\", lwd =  5)\n# lines(density(mmrData$days_since_active), col = \"red\")\n# # distributions of user liftimes and churn lengths look similar \n# \n# # Summary statistics \n# summary(mmrData)\n# # churn liftimes and user lifetimes appear to follow the same distribution with a different mean \n# mean(mmrData$days_since_active) #50.8 \n# mean(mmrData$pre_churn_lifetime_days) #43.6 \n# var(mmrData$days_since_active) # 943.9\n# var(mmrData$pre_churn_lifetime_days) # 977.1 \n# # different means but very similar variances \n# \n# \n# # Regression Model: \n# fit1 <- lm(final_mmr_diff ~ days_since_active + pre_churn_lifetime_days, data = mmrData)\n# # very slightly positive relationships between mmr and days_since_active and pre_churn_lifetime_days\n# # model is likely biased towards the 37/8601 points that show a positive mmr change rather than 0. \n# # Can check this with influential points \n# plot(fit1)\n# # regression model is not informative \n# \n# # MMR Bucket variable \n# mmrBucket_sql <- \"select u_mmrbucket from game_match_finish where date(event_time) > current_date - 2 limit 10000\"\n# mmrBucket <- dbGetQuery(conn, paste(\"SET search_path = app139203;\",mmrBucket_sql, sep = \"\"))\n# mmrBucket$u_mmrbucket <- as.numeric(mmrBucket$u_mmrbucket)\n# attach(mmrBucket)\n# hist(u_mmrbucket)\n# unique(u_mmrbucket)\n# \n# count(u_mmrbucket >= 10) #6535 = 65% \n\n##=======================================\n## Data for average mmrbuckets (5 game average)\n##========================================\nmmrData2_sql  <- \"Select \ndays_since_active\n,pre_churn_lifetime_days\n,avg_pre_churn_mmr\n,avg_post_churn_mmr        \n,final_mmr_diff\nFrom reactivated_users_4_2\nGroup By 1,2,3,4,5\" \n\nmmrData2 <- dbGetQuery(conn, paste(\"SET search_path = app139203;\",\n                                   mmrData2_sql, sep = \"\"))\n\n# Data exploration \nhist(mmrData2$pre_churn_lifetime_days)\nhist(mmrData2$final_mmr_diff)\ncount(mmrData2$final_mmr_diff == 0)\ncount(mmrData2$final_mmr_diff < 0)\n# get rid of users who have 0 lifetime days before churn  \n\n\n## Regression Models \nfit2 <- lm(final_mmr_diff ~ pre_churn_lifetime_days + days_since_active,\n           data = mmrData2)\nsummary(fit2)\n# both B1 and B2 are positive\n# R^2 = .14 \n\n# Suppress the intercept \nfit2.1 <- lm(final_mmr_diff ~ pre_churn_lifetime_days + days_since_active -1 ,\n             data = mmrData2)\nsummary(fit2.1)\n# both slopes are negative \n# not an improvement\n\n# Single Explanatory Variable regression relationships \nfit3 <- lm(final_mmr_diff ~ days_since_active,\n           data = mmrData2)\nsummary(fit3) \n# still shows a postive relationship between mmr difference and days_since_active \nfit4 <- lm(final_mmr_diff ~ pre_churn_lifetime_days,\n           data = mmrData2)\nsummary(fit4) \n\n\n## Summary of 5 game average mmr change\ncount(mmrData2$final_mmr_diff == 0) \n88270/dim(mmrData2)[1] \n#32% of users show no change through 5 games \ncount(mmrData2$final_mmr_diff > 0) \n42624/dim(mmrData2)[1] \n#16% show an improvement \ncount(mmrData2$final_mmr_diff < 0) \n132483/dim(mmrData2)[1]  \n#48% of users show a decline of at least 1 mmr bucket\n\n\n## histogram\n# determine # of bins \ncount(unique(mmrData2$final_mmr_diff)) #55 unique values\n# necessary for geom_histogram() to use discrete X values  \ng1 <- ggplot(mmrData2,\n             aes(x = final_mmr_diff)) + \n  geom_histogram(aes(fill = ..count..),  # creates a gradient legend by relative counts \n                 bins = 55) + \n  ggtitle(\"Pre and post churn 5 game average MMR Difference\")\n# plotly \nplot1 <-ggplotly(g1)\nplot1\n# to do: Y-axis as a percentage \n  \n\n# data table \nmmrData2 <- data.table(mmrData2)\n\n## Create pre-churn lifetime in months variable  \nmmrData2[pre_churn_lifetime_days <= 30, pre_churn_months := 1]\nmmrData2[pre_churn_lifetime_days > 30 & pre_churn_lifetime_days <= 60, pre_churn_months := 2]\nmmrData2[pre_churn_lifetime_days > 60 & pre_churn_lifetime_days <= 90, pre_churn_months := 3]\nmmrData2[pre_churn_lifetime_days > 90 & pre_churn_lifetime_days <= 120, pre_churn_months := 4]\nmmrData2[pre_churn_lifetime_days > 120 & pre_churn_lifetime_days <= 150, pre_churn_months := 5]\n\n## Examine density plots of mmr difference by pre-churn lifetime length  \n# best to compare no more than two or three at a time\nplot(density(mmrData2[pre_churn_months == 1]$final_mmr_diff, na.rm = T))\nlines(density(mmrData2[pre_churn_months == 2]$final_mmr_diff, na.rm = T), col = \"green\")\nlines(density(mmrData2[pre_churn_months == 3]$final_mmr_diff, na.rm = T), col = \"red\")\nlines(density(mmrData2[pre_churn_months == 4]$final_mmr_diff, na.rm = T), col = \"blue\")\nlines(density(mmrData2[pre_churn_months == 5]$final_mmr_diff, na.rm = T), col = \"orange\")\n\n# Summary statistics \nsummary(mmrData2[pre_churn_months == 1]$final_mmr_diff)\nsummary(mmrData2[pre_churn_months == 2]$final_mmr_diff)\nsummary(mmrData2[pre_churn_months == 3]$final_mmr_diff)\nsummary(mmrData2[pre_churn_months == 4]$final_mmr_diff)\nsummary(mmrData2[pre_churn_months == 5]$final_mmr_diff)\n# mean mmr difference approaches 0 as user lifetimes before churn increase \n\n## Create Churn length by months variable\nmmrData2[days_since_active <= 30, months_since_active := 1]\nmmrData2[days_since_active > 30 & days_since_active <= 60, months_since_active := 2]\nmmrData2[days_since_active > 60 & days_since_active <= 90, months_since_active := 3]\nmmrData2[days_since_active > 90 & days_since_active <= 120, months_since_active := 4]\nmmrData2[days_since_active > 120 & days_since_active <= 150, months_since_active := 5]\n\n## Examine density plots of mmr difference by months inactive \n# best to compare no more than two or three at a time\nplot(density(mmrData2[months_since_active == 1]$final_mmr_diff, na.rm = T))\nlines(density(mmrData2[months_since_active == 2]$final_mmr_diff, na.rm = T), col = \"green\")\nlines(density(mmrData2[months_since_active == 3]$final_mmr_diff, na.rm = T), col = \"red\")\nlines(density(mmrData2[months_since_active == 4]$final_mmr_diff, na.rm = T), col = \"blue\")\nlines(density(mmrData2[months_since_active == 5]$final_mmr_diff, na.rm = T), col = \"orange\")\n# each month churn period is less dense in the negative and positive regions than months = 1, \n# they are all more dense than months = 1 at 0.  This must be the reason for the positive linear \n# trend in the regression line \n\n# Summary statistics \nsummary(mmrData2[months_since_active == 1]$final_mmr_diff)\nsummary(mmrData2[months_since_active == 2]$final_mmr_diff)\nsummary(mmrData2[months_since_active == 3]$final_mmr_diff)\nsummary(mmrData2[months_since_active == 4]$final_mmr_diff)\nsummary(mmrData2[months_since_active == 5]$final_mmr_diff) \n# Check subset sizes: \nfor(i in 1:5){\n  print(dim(mmrData2[months_since_active == i])[1])\n}\n\n## Scatterplots between explantory variables and mmr decay \n# relationship between user lifetime and mmr decay \nplot3 <- plot(mmrData2$pre_churn_lifetime_days[1:3000],\n              mmrData2$final_mmr_diff[1:3000],\n              xlab = \"Pre-churn liftime (days)\",\n              ylab = \"MMR Difference\",\n              main = \"5 game average mmr difference pre and post\n              churn by pre churn lifetime\")\n# at a first glance it appears the relationship is independent - no apparent linear trend \n# Examine by weeks, months, and quartiles\n\n## relationship between churn period  and mmr decay \nplot4 <- plot(mmrData2$days_since_active[1:3000],\n              mmrData2$final_mmr_diff[1:3000],\n              xlab = \"Days since active\", \n              ylab = \"MMR Difference\",\n              main = \"5 game average mmr difference pre and post\n              churn by churn period\")\n# seems like influential points drive the regression model towards a positive slope \n\n\n##==========================================================================================\n## Data for mmr difference between last match before churn and first match upon reactivation\n##==========================================================================================\nmmrData3_sql  <- \"Select \ndays_since_active\n,pre_churn_lifetime_days\n,pre_churn_mmr\n,post_churn_mmr        \n,final_mmr_diff\nFrom reactivated_users_4_3\nGroup By 1,2,3,4,5\" \n\nmmrData3 <- dbGetQuery(conn, paste(\"SET search_path = app139203;\",mmrData3_sql, sep = \"\"))\n\n# Data exploration \nhist(mmrData3$final_mmr_diff, breaks = 50)\ndim(mmrData3)\n\n## Histogram \n# determine # of bins: \ncount(unique(mmrData3$final_mmr_diff))\n# 59 unique values \ng2 <- ggplot(mmrData3,\n             aes(x = final_mmr_diff)) + \n  geom_histogram(aes(fill = ..count..),  # creates a legend gradient based on relative counts\n                 bins = 59) + \n  ggtitle(\"Pre and post churn single game MMR Difference\") \nplot2 <- ggplotly(g2)\nplot2\n",
    "created" : 1476315416773.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2797023906",
    "id" : "3F22EF60",
    "lastKnownWriteTime" : 1476407910,
    "last_content_update" : 1476407910405,
    "path" : "~/Documents/R_Projects/MMR Decay/mmr_decay.R",
    "project_path" : "mmr_decay.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}